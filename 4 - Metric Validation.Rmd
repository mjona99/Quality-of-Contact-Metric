---
title: "4 - Metric Creation and Validation"
output: html_notebook
---


Descriptive Performance: the correlation between the metric and same-year team runs/PA;
Reliability Performance: the correlation between the metric and itself in the following year; and
Predictive Performance: the correlation between the metric and the following year’s runs/PA.

```{r}
batted_ball_results_2015
batted_ball_results_2016
batted_ball_results_2017 
batted_ball_results_2018 
batted_ball_results_2019 
```

Reliability Performance
```{r}
group.2015 <- batted_ball_results_2015 %>%
  group_by(player_name) %>%
  summarise(BBE_2015 = n(),
            avg_qcp_2015 = mean(qcp),
            woba_con_2015 = mean(woba_value / woba_denom, na.rm=T)) %>%
  filter(BBE_2015 > 250)

group.2016 <- batted_ball_results_2016 %>%
  group_by(player_name) %>%
  summarise(BBE_2016 = n(),
            avg_qcp_2016 = mean(qcp),
            woba_con_2016 = mean(woba_value / woba_denom, na.rm=T)) %>%
  filter(BBE_2016 > 250)

group.2017 <- batted_ball_results_2017 %>%
  group_by(player_name) %>%
  summarise(BBE_2017 = n(),
            avg_qcp_2017 = mean(qcp),
            woba_con_2017 = mean(woba_value / woba_denom, na.rm=T)) %>%
  filter(BBE_2017 > 250)

group.2018 <- batted_ball_results_2018 %>%
  group_by(player_name) %>%
  summarise(BBE_2018 = n(),
            avg_qcp_2018 = mean(qcp),
            woba_con_2018 = mean(woba_value / woba_denom, na.rm=T)) %>%
  filter(BBE_2018 > 250)

group.2019 <- batted_ball_results_2019 %>%
  group_by(player_name) %>%
  summarise(BBE_2019 = n(),
            avg_qcp_2019 = mean(qcp),
            woba_con_2019 = mean(woba_value / woba_denom, na.rm=T)) %>%
  filter(BBE_2019 > 250)

# 2015-2016
joined_15_16 <- left_join(group.2015, group.2016, by = "player_name") %>%
  filter(player_name %in% group.2015$player_name & player_name %in% group.2016$player_name)

cor(joined_15_16$avg_qcp_2015, joined_15_16$avg_qcp_2016) # n > 250 = 0.7783435
summary(lm(avg_qcp_2016 ~ avg_qcp_2015, data = joined_15_16)) # n > 250 =  0.6058
#cor this season qcp with next wobacon
cor(joined_15_16$avg_qcp_2015, joined_15_16$woba_con_2016) # n > 250 =  0.7238685
summary(lm(woba_con_2016 ~ avg_qcp_2015, data = joined_15_16)) # n > 250, R^2 = 0.524

# 2016-2017
joined_16_17 <- left_join(group.2016, group.2017, by = "player_name") %>%
  filter(player_name %in% group.2016$player_name & player_name %in% group.2017$player_name)

cor(joined_16_17$avg_qcp_2016, joined_16_17$avg_qcp_2017) # n > 250 = 0.5735659
summary(lm(avg_qcp_2017 ~ avg_qcp_2016, data = joined_16_17)) # n > 250 =  0.329
#cor this season qcp with next wobacon
cor(joined_16_17$avg_qcp_2016, joined_16_17$woba_con_2017) # n > 250 =  0.455185
summary(lm(woba_con_2017 ~ avg_qcp_2016, data = joined_16_17)) # n > 250, R^2 = 0.2072

# 2017-2018
joined_17_18 <- left_join(group.2017, group.2018, by = "player_name") %>%
  filter(player_name %in% group.2017$player_name & player_name %in% group.2018$player_name)

cor(joined_17_18$avg_qcp_2017, joined_17_18$avg_qcp_2018) # n > 250 = 0.7253101
summary(lm(avg_qcp_2018 ~ avg_qcp_2017, data = joined_17_18)) # n > 250 =  0.5261
#cor this season qcp with next wobacon
cor(joined_17_18$avg_qcp_2017, joined_17_18$woba_con_2018) # n > 250 =  0.6887269
summary(lm(woba_con_2018 ~ avg_qcp_2017, data = joined_17_18)) # n > 250, R^2 = 0.4743

# 2018-2019
joined_18_19 <- left_join(group.2018, group.2019, by = "player_name") %>%
  filter(player_name %in% group.2018$player_name & player_name %in% group.2019$player_name)

cor(joined_18_19$avg_qcp_2018, joined_18_19$avg_qcp_2019) # n > 250 = 0.7026071
summary(lm(avg_qcp_2019 ~ avg_qcp_2018, data = joined_18_19)) # n > 250 =  0.4937
#cor this season qcp with next wobacon
cor(joined_18_19$avg_qcp_2018, joined_18_19$woba_con_2019) # n > 250 =  0.6328501
summary(lm(woba_con_2019 ~ avg_qcp_2018, data = joined_18_19)) # n > 250, R^2 = 0.4005
```

Putting in each team's runs and PA for the 2015-2019 seasons. Guess I could also do the 2020 season.
Predictive Performance: the correlation between the metric and the following year’s runs/PA.

```{r}
teams_scoring_2 <- read_csv("teams_scoring_2.csv")

qcp_2015 <- batted_ball_results_2015 %>%
  group_by(batter_team) %>%
  summarise(bbe_2015 = n(),
            qcp_2015 = mean(qcp))

qcp_2016 <- batted_ball_results_2016 %>%
  group_by(batter_team) %>%
  summarise(bbe_2016 = n(),
            qcp_2016 = mean(qcp))

qcp_2017 <- batted_ball_results_2017 %>%
  group_by(batter_team) %>%
  summarise(bbe_2017 = n(),
            qcp_2017 = mean(qcp))

qcp_2018 <- batted_ball_results_2018 %>%
  group_by(batter_team) %>%
  summarise(bbe_2018 = n(),
            qcp_2018 = mean(qcp))

qcp_2019 <- batted_ball_results_2019 %>%
  group_by(batter_team) %>%
  summarise(bbe_2019 = n(),
            qcp_2019 = mean(qcp))

qcp_all <- left_join(qcp_2015, qcp_2016, by = "batter_team") %>%
  left_join(., qcp_2017, by = "batter_team") %>%
  left_join(., qcp_2018, by = "batter_team") %>%
  left_join(., qcp_2019, by = "batter_team")

qcp_and_scoring <- left_join(x = qcp_all, y = teams_scoring_2, by = c("batter_team" = "Team"))

qcp_and_scoring %<>%
  mutate(total_pa = G * PA,
         total_r = G * R,
         runs_per_pa = total_r / total_pa)

```

Descriptive Performance: the correlation between the metric and same-year team runs/PA;
```{r}
### 2015
qcp_and_scoring %>%
  filter(Year == 2015) %$%
  cor(runs_per_pa, qcp_2015) # 0.5933172

### 2016
qcp_and_scoring %>%
  filter(Year == 2016) %$%
  cor(runs_per_pa, qcp_2016) #0.6646133

### 2017
qcp_and_scoring %>%
  filter(Year == 2017) %$%
  cor(runs_per_pa, qcp_2017) #  0.659218

### 2018
qcp_and_scoring %>%
  filter(Year == 2018) %$%
  cor(runs_per_pa, qcp_2018) #  0.7716518

### 2019
qcp_and_scoring %>%
  filter(Year == 2019) %$%
  cor(runs_per_pa, qcp_2019) # 0.8270482
```

Predictive Performance: the correlation between the metric and the following year’s runs/PA.
```{r}
### 2015 qcp to 2016 runs/pa
qcp_and_scoring %>%
  filter(Year == 2016) %$%
  cor(runs_per_pa, qcp_2015) # 0.6096966

### 2016 qcp to 2017 runs/pa
qcp_and_scoring %>%
  filter(Year == 2017) %$%
  cor(runs_per_pa, qcp_2016) #0.3272711

### 2017 qcp to 2018 runs/pa
qcp_and_scoring %>%
  filter(Year == 2018) %$%
  cor(runs_per_pa, qcp_2017) #  0.2390079

### 2018 qcp to 2019 runs/pa
qcp_and_scoring %>%
  filter(Year == 2019) %$%
  cor(runs_per_pa, qcp_2018) #  0.6513941

### 2019 qcp to 2020 runs/pa
qcp_and_scoring %>%
  filter(Year == 2020) %$%
  cor(runs_per_pa, qcp_2019) #  0.3568525
```

